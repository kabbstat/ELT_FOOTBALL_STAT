name: Football ELT Pipeline CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: football_stats_db_test
          POSTGRES_USER: football_user
          POSTGRES_PASSWORD: test_password
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Cache Python dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirement.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirement.txt
    
    - name: Setup Database Schemas
      env:
        PGPASSWORD: test_password
      run: |
        psql -h localhost -U football_user -d football_stats_db_test -c "CREATE SCHEMA IF NOT EXISTS bronze;"
        psql -h localhost -U football_user -d football_stats_db_test -c "CREATE SCHEMA IF NOT EXISTS silver;"
        psql -h localhost -U football_user -d football_stats_db_test -c "CREATE SCHEMA IF NOT EXISTS gold;"
    
    - name: Validate Python Syntax
      run: |
        python -m py_compile extractor/foot_data_enhanced.py
        python -m py_compile extractor/load_postgres_enhanced.py
        python -m py_compile config/settings.py
        echo "✅ Python syntax validation passed"
    
    - name: Install DBT
      run: |
        pip install dbt-postgres
    
    - name: Validate DBT Project
      working-directory: dbt_football/stat_foot
      env:
        DB_HOST: localhost
        DB_PORT: 5432
        DB_NAME: football_stats_db_test
        DB_USER: football_user
        DB_PASS: test_password
      run: |
        echo "
        stat_foot:
          outputs:
            dev:
              type: postgres
              host: localhost
              port: 5432
              user: football_user
              password: test_password
              dbname: football_stats_db_test
              schema: gold
              threads: 4
          target: dev
        " > profiles.yml
        dbt debug --profiles-dir .
        echo "✅ DBT configuration valid"
    
    - name: Summary
      run: |
        echo "## ✅ CI Pipeline Passed" >> $GITHUB_STEP_SUMMARY
        echo "- Python syntax validation: ✅" >> $GITHUB_STEP_SUMMARY
        echo "- Database schemas created: ✅" >> $GITHUB_STEP_SUMMARY
        echo "- DBT configuration valid: ✅" >> $GITHUB_STEP_SUMMARY
